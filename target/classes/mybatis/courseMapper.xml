<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
  <mapper namespace="course">
  	<select id="getCourse" parameterType="pageDto" resultType="courseDto">
  		<![CDATA[
	  		SELECT 
				  @rownum:=@rownum +1 as rnum
				, seq
				, title
				, app_personnel
				, ent_personnel
				, DATE_FORMAT(input_date, '%Y-%m-%d') as input_date
				, DATE_FORMAT(start_date, '%Y-%m-%d') as start_date
				, DATE_FORMAT(expire_date, '%Y-%m-%d') as expire_date
			FROM course
			  , (SELECT @rownum:=0) R
			WHERE title LIKE CONCAT('%', #{keyword} , '%')
			ORDER BY rnum DESC
			LIMIT ${cri.pageStart}, ${cri.amount}
			]]>
  	</select>

	<select id="getTotal" parameterType="String" resultType="int">
		SELECT COUNT(*) as TOTAL_COUNT
		FROM course
		WHERE title LIKE CONCAT('%', #{value}, '%') 
	</select>
  	
  	<select id="getCourseDetail" parameterType="courseDto" resultType="courseDto">
  		SELECT 
				seq
			  , title
			  , category
			  , type
			  , class_hour
			  , DATE_FORMAT(start_date, '%Y-%m-%d') as start_date
			  , DATE_FORMAT(expire_date, '%Y-%m-%d') as expire_date
			  , ent_personnel
			  , DATE_FORMAT(app_start_date, '%Y-%m-%d') as app_start_date
			  , DATE_FORMAT(app_expire_date,  '%Y-%m-%d') as app_expire_date
			  , DATE_FORMAT(input_date, '%Y-%m-%d') as input_date
			  , detail
  		FROM course
  		WHERE seq = #{seq}
  	</select>
  	
	<select id="getCourseAppCount" parameterType="Hashmap" resultType="Hashmap">
		<![CDATA[
			select COUNT(u.seq) as COUNT
			       , u.seq 
			       , u.USER_NAME
			       , u.USER_ID
			       , u.USER_ADDR
			       , u.USER_EMAIL
			       , u.USER_PHONE
			       , c.seq 
			       , c.title 
			       , a.APP_NO 
			       , DATE_FORMAT(APP_DATE, '%Y-%m-%d') as APP_DATE
			FROM application a, course c , member m, (SELECT @rownum:=0) R
			WHERE a.seq = u.seq  
				  AND c.seq = a.seq 
				  AND title LIKE CONCAT('%', #{keyword}, '%')
			ORDER BY rnum DESC
			LIMIT ${cri.pageStart}, ${cri.amount}
		]]>
	</select>
	
	<select id="getAppTotal" parameterType="String" resultType="int">
		SELECT COUNT(*) as APP_TOTAL_COUNT
		FROM application
		WHERE seq =#{seq} 
		  AND seq = #{seq}
	</select>
		
  	<insert id="inputCourseApp" parameterType="pageDto">
  		INSERT INTO APPLICATION
  			(			
  				a.seq
			  , u.seq
			  , a.input_date
			  , (SELECT COUNT(u.seq) as COUNT
			  , u.seq 
			  , u.name
			  , u.id
			  , u.address
			  , u.email
			  , u.phone
			  , c.seq 
			  , c.title 
			  , DATE_FORMAT(a.input_date, '%Y-%m-%d') as input_date
		FROM application a, course c , user u, (SELECT @rownum:=0) R
		WHERE a.seq = u.seq  
		  AND c.seq = a.seq 
		ORDER BY rnum DESC)
		) VALUES (		   
			   #{seq}
			 , #{seq}
			 , NOW())
  	</insert>
  
  </mapper>