<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
  <mapper namespace="course">
  <!-- 전체 리스트 -->
  	<select id="courseList" parameterType="pageDto" resultType="courseDto">
  		<![CDATA[
	  		SELECT 
						  @rownum:=@rownum +1 as rnum
						, C_NO
						, C_NAME
						, APP_PERSONNEL
						, ENT_PERSONNEL
						, DATE_FORMAT(C_REGDATE, '%Y-%m-%d') as C_REGDATE
						, DATE_FORMAT(C_START_DATE, '%Y-%m-%d') as C_START_DATE
						, DATE_FORMAT(C_LAST_DATE, '%Y-%m-%d') as C_LAST_DATE
						
				FROM mydb.COURSE C, (SELECT @rownum:=0) R
				
				WHERE C_NAME LIKE CONCAT('%', #{keyword} , '%')
				
				ORDER BY rnum DESC
				
				LIMIT ${cri.pageStart}, ${cri.amount}
			]]>
  	</select>
  	
  	<!-- 게시글 총 갯수 -->
		<select id="getTotal" parameterType="String" resultType="int">
			SELECT COUNT(*) as TOTAL_COUNT
			FROM mydb.COURSE
			WHERE C_NAME LIKE CONCAT('%', #{value}, '%') 
		</select>
  	
  	<!-- 상세 페이지 -->
  	<select id="courseDetail" parameterType="courseDto" resultType="courseDto">
  		SELECT 
  				C_NO
  			  , C_NAME
  			  , C_CATEGORY
  			  , C_TYPE
  			  , C_START_TIME
  			  , C_TIME
  			  , DATE_FORMAT(C_START_DATE, '%Y-%m-%d') as C_START_DATE
  			  , DATE_FORMAT(C_LAST_DATE, '%Y-%m-%d') as C_LAST_DATE
  			  , ENT_PERSONNEL
  			  , DATE_FORMAT(APP_START_DATE, '%Y-%m-%d') as APP_START_DATE
  			  , DATE_FORMAT(APP_LAST_DATE,  '%Y-%m-%d') as APP_LAST_DATE
  			  , DATE_FORMAT(C_REGDATE, '%Y-%m-%d') as C_REGDATE
  			  , C_DETAIL
  			  , C_TUITION
  			  
  		FROM mydb.COURSE
  		
  		WHERE C_NO = #{c_no}
  	</select>
  	
  	<!-- 교육 신청 전 count -->
	<select id="courseAppCount" parameterType="Hashmap" resultType="Hashmap">
		<![CDATA[
			select COUNT(m.USER_NO) as COUNT
			       , m.USER_NO 
			       , m.USER_NAME
			       , m.USER_ID
			       , m.USER_ADDR
			       , m.USER_EMAIL
			       , m.USER_PHONE
			       , c.C_NO 
			       , c.C_NAME 
			       , a.APP_NO 
			       , DATE_FORMAT(APP_DATE, '%Y-%m-%d') as APP_DATE
			       
			FROM mydb.application a, mydb.course c , mydb.member m, (SELECT @rownum:=0) R
			
			WHERE a.USER_NO = m.USER_NO  
				  AND c.C_NO = a.C_NO 
				  AND C_NAME LIKE CONCAT('%', #{keyword}, '%')
			
			ORDER BY rnum DESC
				
				LIMIT ${cri.pageStart}, ${cri.amount}
			]]>
	</select>
	
	<select id="getAppTotal" parameterType="String" resultType="int">
		SELECT COUNT(*) as APP_TOTAL_COUNT
		FROM mydb.application
		WHERE C_NO =#{c_no} 
		  AND USER_NO = #{user_no}
	</select>
		
  	<!-- 교육 신청 -->
  	<insert id="courseAppInsert" parameterType="pageDto">
  		INSERT INTO mydb.APPLICATION
  			(			C_NO
					  , USER_NO
					  , APP_DATE
					  , (SELECT   COUNT(m.USER_NO) as COUNT
					       		, m.USER_NO 
					       		, m.USER_NAME
					       		, m.USER_ID
					       		, m.USER_ADDR
					       		, m.USER_EMAIL
					       		, m.USER_PHONE
					       		, c.C_NO 
					       		, c.C_NAME 
					       		, a.APP_NO 
					       		, DATE_FORMAT(APP_DATE, '%Y-%m-%d') as APP_DATE
					       
						FROM mydb.application a, mydb.course c , mydb.member m, (SELECT @rownum:=0) R
						
						WHERE a.USER_NO = m.USER_NO  
							  AND c.C_NO = a.C_NO 
						
						ORDER BY rnum DESC)
			)
			VALUES
			(		   
					   #{c_no}
					 , #{user_no}
					 , NOW()
			)
  	</insert>
  
  </mapper>